---
description: https://github.com/hiyouga/LLaMA-Efficient-Tuning/tree/main
---

# ğŸ¦ˆ LLaMA-Efficient-Tuning\&text-generation-webui

**ä»“åº“åœ°å€**ï¼š[https://github.com/hiyouga/LLaMA-Efficient-Tuning/tree/main](https://github.com/hiyouga/LLaMA-Efficient-Tuning/tree/main)

**å¯è§†åŒ–ï¼š**[https://github.com/oobabooga/text-generation-webui/tree/main](https://github.com/oobabooga/text-generation-webui/tree/main)



### æ¨¡å‹

* [LLaMA](https://github.com/facebookresearch/llama) (7B/13B/33B/65B)
* [LLaMA-2](https://huggingface.co/meta-llama) (7B/13B/70B)
* [BLOOM](https://huggingface.co/bigscience/bloom) & [BLOOMZ](https://huggingface.co/bigscience/bloomz) (560M/1.1B/1.7B/3B/7.1B/176B)
* [Falcon](https://huggingface.co/tiiuae/falcon-7b) (7B/40B)
* [Baichuan](https://huggingface.co/baichuan-inc/baichuan-7B) (7B/13B)
* [InternLM](https://github.com/InternLM/InternLM) (7B)

### å¾®è°ƒæ–¹æ³•

* [äºŒæ¬¡é¢„è®­ç»ƒ](https://s3-us-west-2.amazonaws.com/openai-assets/research-covers/language-unsupervised/language\_understanding\_paper.pdf)
  * å…¨å‚æ•°å¾®è°ƒ
  * éƒ¨åˆ†å‚æ•°å¾®è°ƒ
  * [LoRA](https://arxiv.org/abs/2106.09685)
  * [QLoRA](https://arxiv.org/abs/2305.14314)
* [æŒ‡ä»¤ç›‘ç£å¾®è°ƒ](https://arxiv.org/abs/2109.01652)
  * å…¨å‚æ•°å¾®è°ƒ
  * éƒ¨åˆ†å‚æ•°å¾®è°ƒ
  * [LoRA](https://arxiv.org/abs/2106.09685)
  * [QLoRA](https://arxiv.org/abs/2305.14314)
* [äººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ ï¼ˆRLHFï¼‰](https://arxiv.org/abs/2203.02155)
  * [LoRA](https://arxiv.org/abs/2106.09685)
  * [QLoRA](https://arxiv.org/abs/2305.14314)

### æ•°æ®é›†

* ç”¨äºäºŒæ¬¡é¢„è®­ç»ƒ:
  * [Wiki Demo (en)](https://github.com/hiyouga/LLaMA-Efficient-Tuning/blob/main/data/wiki\_demo.txt)
  * [RefinedWeb (en)](https://huggingface.co/datasets/tiiuae/falcon-refinedweb)
  * [StarCoder (en)](https://huggingface.co/datasets/bigcode/starcoderdata)
  * [Wikipedia (en)](https://huggingface.co/datasets/olm/olm-wikipedia-20221220)
  * [Wikipedia (zh)](https://huggingface.co/datasets/pleisto/wikipedia-cn-20230720-filtered)
* ç”¨äºæŒ‡ä»¤ç›‘ç£å¾®è°ƒ:
  * [Stanford Alpaca (en)](https://github.com/tatsu-lab/stanford\_alpaca)
  * [Stanford Alpaca (zh)](https://github.com/ymcui/Chinese-LLaMA-Alpaca)
  * [GPT-4 Generated Data (en\&zh)](https://github.com/Instruction-Tuning-with-GPT-4/GPT-4-LLM)
  * [Open Assistant (multilingual)](https://huggingface.co/datasets/OpenAssistant/oasst1)
  * [Self-cognition (zh)](https://github.com/hiyouga/LLaMA-Efficient-Tuning/blob/main/data/self\_cognition.json)
  * [ShareGPT (zh)](https://huggingface.co/datasets/QingyiSi/Alpaca-CoT/tree/main/Chinese-instruction-collection)
  * [RefGPT (zh)](https://github.com/sufengniu/RefGPT)
  * [Guanaco Dataset (multilingual)](https://huggingface.co/datasets/JosephusCheung/GuanacoDataset)
  * [BELLE 2M (zh)](https://huggingface.co/datasets/BelleGroup/train\_2M\_CN)
  * [BELLE 1M (zh)](https://huggingface.co/datasets/BelleGroup/train\_1M\_CN)
  * [BELLE 0.5M (zh)](https://huggingface.co/datasets/BelleGroup/train\_0.5M\_CN)
  * [BELLE Dialogue 0.4M (zh)](https://huggingface.co/datasets/BelleGroup/generated\_chat\_0.4M)
  * [BELLE School Math 0.25M (zh)](https://huggingface.co/datasets/BelleGroup/school\_math\_0.25M)
  * [BELLE Multiturn Chat 0.8M (zh)](https://huggingface.co/datasets/BelleGroup/multiturn\_chat\_0.8M)
  * [Firefly 1.1M (zh)](https://huggingface.co/datasets/YeungNLP/firefly-train-1.1M)
  * [CodeAlpaca 20k (en)](https://huggingface.co/datasets/sahil2801/CodeAlpaca-20k)
  * [Alpaca CoT (multilingual)](https://huggingface.co/datasets/QingyiSi/Alpaca-CoT)
  * [Web QA (zh)](https://huggingface.co/datasets/suolyer/webqa)
  * [UltraChat (en)](https://github.com/thunlp/UltraChat)
  * [WebNovel (zh)](https://huggingface.co/datasets/zxbsmk/webnovel\_cn)
* ç”¨äºå¥–åŠ±æ¨¡å‹è®­ç»ƒ:
  * [HH-RLHF (en)](https://huggingface.co/datasets/Anthropic/hh-rlhf)
  * [Open Assistant (multilingual)](https://huggingface.co/datasets/OpenAssistant/oasst1)
  * [GPT-4 Generated Data (en\&zh)](https://github.com/Instruction-Tuning-with-GPT-4/GPT-4-LLM)

ä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒ [data/README.md](https://github.com/hiyouga/LLaMA-Efficient-Tuning/blob/main/data/README\_zh.md) æ–‡ä»¶ã€‚

éƒ¨åˆ†æ•°æ®é›†çš„ä½¿ç”¨éœ€è¦ç¡®è®¤ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ä¸‹è¿°å‘½ä»¤ç™»å½•æ‚¨çš„ Hugging Face è´¦æˆ·ã€‚

```
pip install --upgrade huggingface_hub
huggingface-cli login
```

### è½¯ä»¶ä¾èµ–

* Python 3.8+ å’Œ PyTorch 1.13.1+
* ğŸ¤—Transformers, Datasets, Accelerate, PEFT å’Œ TRL
* jieba, rouge-chinese å’Œ nltk (ç”¨äºè¯„ä¼°)
* gradio å’Œ matplotlib (ç”¨äºç½‘é¡µç«¯äº¤äº’)
* uvicorn, fastapi å’Œ sse-starlette (ç”¨äº API)

ä»¥åŠ **å¼ºè€Œæœ‰åŠ›çš„ GPU**ï¼

### å¦‚ä½•ä½¿ç”¨

#### æ•°æ®å‡†å¤‡ï¼ˆå¯è·³è¿‡ï¼‰

å…³äºæ•°æ®é›†æ–‡ä»¶çš„æ ¼å¼ï¼Œè¯·å‚è€ƒ `data/example_dataset` æ–‡ä»¶å¤¹çš„å†…å®¹ã€‚æ„å»ºè‡ªå®šä¹‰æ•°æ®é›†æ—¶ï¼Œæ—¢å¯ä»¥ä½¿ç”¨å•ä¸ª `.json` æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ª[æ•°æ®åŠ è½½è„šæœ¬](https://huggingface.co/docs/datasets/dataset\_script)å’Œå¤šä¸ªæ–‡ä»¶ã€‚

æ³¨æ„ï¼šä½¿ç”¨è‡ªå®šä¹‰æ•°æ®é›†æ—¶ï¼Œè¯·æ›´æ–° `data/dataset_info.json` æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶çš„æ ¼å¼è¯·å‚è€ƒ `data/README.md`ã€‚

#### ç¯å¢ƒæ­å»ºï¼ˆå¯è·³è¿‡ï¼‰

```
git clone https://github.com/hiyouga/LLaMA-Efficient-Tuning.git
conda create -n llama_etuning python=3.10
conda activate llama_etuning
cd LLaMA-Efficient-Tuning
pip install -r requirements.txt
```

å¦‚æœè¦åœ¨ Windows å¹³å°ä¸Šå¼€å¯é‡åŒ– LoRAï¼ˆQLoRAï¼‰ï¼Œéœ€è¦å®‰è£…é¢„ç¼–è¯‘çš„ `bitsandbytes` åº“, æ”¯æŒ CUDA 11.1 åˆ° 12.1.

```
pip install https://github.com/jllllll/bitsandbytes-windows-webui/releases/download/wheels/bitsandbytes-0.39.1-py3-none-win_amd64.whl
```

#### æµè§ˆå™¨ä¸€é”®å¾®è°ƒ/æµ‹è¯•

```
python src/train_web.py
```

ç›®å‰ç½‘é¡µ UI ä»…æ”¯æŒå•å¡è®­ç»ƒã€‚

#### äºŒæ¬¡é¢„è®­ç»ƒ

```
CUDA_VISIBLE_DEVICES=0 python src/train_bash.py \
    --stage pt \
    --model_name_or_path path_to_your_model \
    --do_train \
    --dataset wiki_demo \
    --finetuning_type lora \
    --output_dir path_to_pt_checkpoint \
    --overwrite_cache \
    --per_device_train_batch_size 4 \
    --gradient_accumulation_steps 4 \
    --lr_scheduler_type cosine \
    --logging_steps 10 \
    --save_steps 1000 \
    --learning_rate 5e-5 \
    --num_train_epochs 3.0 \
    --plot_loss \
    --fp16
```

#### æŒ‡ä»¤ç›‘ç£å¾®è°ƒ

```
CUDA_VISIBLE_DEVICES=0 python src/train_bash.py \
    --stage sft \
    --model_name_or_path path_to_your_model \
    --do_train \
    --dataset alpaca_gpt4_en \
    --finetuning_type lora \
    --output_dir path_to_sft_checkpoint \
    --overwrite_cache \
    --per_device_train_batch_size 4 \
    --gradient_accumulation_steps 4 \
    --lr_scheduler_type cosine \
    --logging_steps 10 \
    --save_steps 1000 \
    --learning_rate 5e-5 \
    --num_train_epochs 3.0 \
    --plot_loss \
    --fp16
```

#### å¥–åŠ±æ¨¡å‹è®­ç»ƒ

```
CUDA_VISIBLE_DEVICES=0 python src/train_bash.py \
    --stage rm \
    --model_name_or_path path_to_your_model \
    --do_train \
    --dataset comparison_gpt4_en \
    --finetuning_type lora \
    --output_dir path_to_rm_checkpoint \
    --per_device_train_batch_size 4 \
    --gradient_accumulation_steps 4 \
    --lr_scheduler_type cosine \
    --logging_steps 10 \
    --save_steps 1000 \
    --learning_rate 1e-5 \
    --num_train_epochs 1.0 \
    --plot_loss \
    --fp16
```

#### RLHF è®­ç»ƒ

```
CUDA_VISIBLE_DEVICES=0 python src/train_bash.py \
    --stage ppo \
    --model_name_or_path path_to_your_model \
    --do_train \
    --dataset alpaca_gpt4_en \
    --finetuning_type lora \
    --checkpoint_dir path_to_sft_checkpoint \
    --reward_model path_to_rm_checkpoint \
    --output_dir path_to_ppo_checkpoint \
    --per_device_train_batch_size 2 \
    --gradient_accumulation_steps 4 \
    --lr_scheduler_type cosine \
    --logging_steps 10 \
    --save_steps 1000 \
    --learning_rate 1e-5 \
    --num_train_epochs 1.0 \
    --resume_lora_training False \
    --plot_loss
```

#### å¤š GPU åˆ†å¸ƒå¼è®­ç»ƒ

```
accelerate config # é¦–å…ˆé…ç½®åˆ†å¸ƒå¼ç¯å¢ƒ
accelerate launch src/train_bash.py # å‚æ•°åŒä¸Š
```

<details>

<summary>ä½¿ç”¨ DeepSpeed ZeRO-2 è¿›è¡Œå…¨å‚æ•°å¾®è°ƒçš„ Accelerate é…ç½®ç¤ºä¾‹</summary>

```
compute_environment: LOCAL_MACHINE
deepspeed_config:
  gradient_accumulation_steps: 4
  gradient_clipping: 0.5
  offload_optimizer_device: none
  offload_param_device: none
  zero3_init_flag: false
  zero_stage: 2
distributed_type: DEEPSPEED
downcast_bf16: 'no'
machine_rank: 0
main_training_function: main
mixed_precision: fp16
num_machines: 1
num_processes: 4
rdzv_backend: static
same_network: true
tpu_env: []
tpu_use_cluster: false
tpu_use_sudo: false
use_cpu: false
```

</details>

#### æŒ‡æ ‡è¯„ä¼°ï¼ˆBLEUåˆ†æ•°å’Œæ±‰è¯­ROUGEåˆ†æ•°ï¼‰

```
CUDA_VISIBLE_DEVICES=0 python src/train_bash.py \
    --stage sft \
    --model_name_or_path path_to_your_model \
    --do_eval \
    --dataset alpaca_gpt4_en \
    --finetuning_type lora \
    --checkpoint_dir path_to_checkpoint \
    --output_dir path_to_eval_result \
    --per_device_eval_batch_size 8 \
    --max_samples 100 \
    --predict_with_generate
```

æˆ‘ä»¬å»ºè®®åœ¨é‡åŒ–æ¨¡å‹çš„è¯„ä¼°ä¸­ä½¿ç”¨ `--per_device_eval_batch_size=1` å’Œ `--max_target_length 128` å‚æ•°ã€‚

#### æ¨¡å‹é¢„æµ‹

```
CUDA_VISIBLE_DEVICES=0 python src/train_bash.py \
    --stage sft \
    --model_name_or_path path_to_your_model \
    --do_predict \
    --dataset alpaca_gpt4_en \
    --finetuning_type lora \
    --checkpoint_dir path_to_checkpoint \
    --output_dir path_to_predict_result \
    --per_device_eval_batch_size 8 \
    --max_samples 100 \
    --predict_with_generate
```

å¦‚æœéœ€è¦é¢„æµ‹çš„æ ·æœ¬æ²¡æœ‰æ ‡ç­¾ï¼Œè¯·é¦–å…ˆåœ¨ `response` åˆ—ä¸­å¡«å…¥ä¸€äº›å ä½ç¬¦ï¼Œä»¥å…æ ·æœ¬åœ¨é¢„å¤„ç†é˜¶æ®µè¢«ä¸¢å¼ƒã€‚

#### API æœåŠ¡

```
python src/api_demo.py \
    --model_name_or_path path_to_your_model \
    --finetuning_type lora \
    --checkpoint_dir path_to_checkpoint
```

å…³äº API æ–‡æ¡£è¯·è§ `http://localhost:8000/docs`ã€‚

#### å‘½ä»¤è¡Œæµ‹è¯•

```
python src/cli_demo.py \
    --model_name_or_path path_to_your_model \
    --finetuning_type lora \
    --checkpoint_dir path_to_checkpoint
```

#### æµè§ˆå™¨æµ‹è¯•

```
python src/web_demo.py \
    --model_name_or_path path_to_your_model \
    --finetuning_type lora \
    --checkpoint_dir path_to_checkpoint
```

#### å¯¼å‡ºå¾®è°ƒæ¨¡å‹

```
python src/export_model.py \
    --model_name_or_path path_to_your_model \
    --finetuning_type lora \
    --checkpoint_dir path_to_checkpoint \
    --output_dir path_to_export
```
